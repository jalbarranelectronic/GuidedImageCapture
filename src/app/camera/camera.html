<button #startBtn id="startBtn" (click)="startCapture()">Start capture</button>

<video #video id="video" autoplay playsinline muted></video>
<canvas #canvas id="canvas" style="display: none"></canvas>
<canvas #overlayCanvas id="overlayCanvas"></canvas>

<div *ngIf="capturedImage() as photo" class="photo-preview">
  <img [src]="photo" alt="Captured photo" />

  <div class="photo-actions">
    <button class="retry" (click)="capturedImage.set(null)">↻ Retry</button>
    <button class="confirm" (click)="usePhoto()">✔ Use photo</button>
  </div>
</div>

<!-- Toggle switch -->
<div class="toggle-panel">
  <div class="toggle-item">
    <label class="switch">
      <input
        type="checkbox"
        [checked]="showDetections()"
        (change)="toggleDetections()"
      />
      <span class="slider"></span>
    </label>
    <span class="toggle-label">Show detections and proportions</span>
  </div>

  <div class="toggle-item">
    <label class="switch">
      <input type="checkbox" [checked]="showBoxes()" (change)="toggleBoxes()" />
      <span class="slider"></span>
    </label>
    <span class="toggle-label">Show bounding boxes</span>
  </div>
</div>

@if (showDetections()) {
<div class="detections-area">
  <div id="proportionBox">
    Proportion: <span>{{ proportion() !== null ? proportion() : "N/A" }}</span>
    <app-chart
      [newValue]="proportion()"
      [nearThreshold]="nearThreshold()"
      [farThreshold]="farThreshold()"
    ></app-chart>
  </div>

  <!-- ✅ Sliders debajo de la gráfica -->
  <div class="slider-group">
    <label>
      Near threshold ({{ nearThreshold() | number : "1.2-2" }})
      <input
        type="range"
        class="slider-near"
        min="0.81"
        max="1"
        step="0.01"
        [value]="nearThreshold()"
        (input)="setNearThreshold($any($event.target).value)"
      />
    </label>

    <label>
      Far threshold ({{ farThreshold() | number : "1.2-2" }})
      <input
        type="range"
        class="slider-far"
        min="0.5"
        max="0.8"
        step="0.01"
        [value]="farThreshold()"
        (input)="setFarThreshold($any($event.target).value)"
      />
    </label>
  </div>
</div>
}

<div id="closeButton">
  <svg
    width="24"
    height="24"
    viewBox="0 0 24 24"
    fill="none"
    xmlns="http://www.w3.org/2000/svg"
  >
    <path
      d="M6 18L18 6M6 6L18 18"
      stroke="white"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
  </svg>
</div>

<div class="header"></div>

<!-- Marco irregular en SVG -->
<div class="marco-container">
  <svg class="marco-svg" [class.glow]="isAnimating">
    <defs>
      <!-- Gradiente animado -->
      <linearGradient id="glowGradient" gradientTransform="rotate(90)">
        <stop offset="0%" stop-color="#0ff" />
        <stop offset="50%" stop-color="#0f0" />
        <stop offset="100%" stop-color="#0ff" />
      </linearGradient>
      <mask id="corner-mask">
        <polygon fill="#ffffff" points="0 0, 0 25, 25 0"></polygon>
        <polygon fill="#ffffff" points="572 0, 597 0, 597 25"></polygon>
        <polygon fill="#ffffff" points="597 289, 572 289, 597 264"></polygon>
        <polygon fill="#ffffff" points="0 289, 0 264, 25 289"></polygon>
      </mask>
      <mask id="hole-mask">
        <symbol
          id="reference-frame-mask"
          [attr.viewBox]="0 + ' ' + 0 + ' ' + svgWidth + ' ' + svgHeight"
          preserveAspectRatio="xMidYMid meet"
        >
          <path id="outline-hole" [attr.d]="outlinePathData" fill="#000" />
        </symbol>
        <rect x="0" y="0" width="100%" height="100%" fill="#FFF" />
        <use
          href="#reference-frame-mask"
          transform="scale(1.05)"
          style="transform-origin: center; transform-box: fill-box"
        />
      </mask>
      <symbol
        id="reference-frame"
        [attr.viewBox]="0 + ' ' + 0 + ' ' + svgWidth + ' ' + svgHeight"
        preserveAspectRatio="xMidYMid meet"
      >
        <path
          #rectPath
          id="rectPath"
          [attr.d]="rectPathData"
          class="rect-path"
        />
        <path
          #irregularPath
          [attr.d]="outlinePathData"
          class="irregular-path"
        />
      </symbol>
    </defs>
    <rect id="overlay-box" x="0" y="0" />
    <use href="#reference-frame" />
  </svg>
</div>

<div id="feedback">{{ feedback() }}</div>

<div class="orientation-warning">
  <div class="orientation-content">
    <div class="phone-icon"></div>
    <p>Please turn your device to landscape orientation to continue.</p>
  </div>
</div>
