<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Guided image capture</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    body, html {
      margin:0; padding:0; overflow:hidden; background:black; height:100%;
    }
    #video {
      position: absolute;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      object-fit: cover;
    }
    #overlayCanvas {
      position: absolute;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      pointer-events: none;
    }
    #feedback {
      position: absolute;
      bottom: 20px; left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      background: rgba(0,0,0,0.6);
      color: white;
      border-radius: 10px;
      font-size: 18px;
    }
    #detections {
      position: absolute;
      top: 20px; left: 20px;
      padding: 10px;
      background: rgba(0,0,0,0.6);
      color: #0f0;
      font-family: monospace;
      font-size: 14px;
      border-radius: 8px;
      max-width: 50%;
      max-height: 30%;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    #proportionBox {
      position: absolute;
      top: 140px; left: 20px;
      padding: 10px;
      background: rgba(0,0,0,0.6);
      color: #0ff;
      font-family: monospace;
      font-size: 14px;
      border-radius: 8px;
      max-width: 50%;
    }
    #proportionChart {
      display: block;
      margin-top: 8px;
      background: #111;
      border: 1px solid #0ff;
      border-radius: 4px;
    }
    #startBtn {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      padding: 15px 30px;
      font-size: 18px;
      border-radius: 10px;
      border: none;
      background: limegreen;
      color: white;
      cursor: pointer;
      z-index: 1000;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
</head>
<body>
  <button id="startBtn">Start capture</button>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" style="display:none;"></canvas>
  <canvas id="overlayCanvas"></canvas>
  <div id="feedback">Loading ODM...</div>
  <div id="detections">No detections yet...</div>
  <div id="proportionBox">
    Proportion: N/A
    <canvas id="proportionChart" width="200" height="80"></canvas>
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const overlayCanvas = document.getElementById('overlayCanvas');
    const feedback = document.getElementById('feedback');
    const detectionsBox = document.getElementById('detections');
    const proportionBox = document.getElementById('proportionBox');
    const proportionChart = document.getElementById('proportionChart');
    const chartCtx = proportionChart.getContext('2d');
    const ctx = canvas.getContext('2d');
    const overlayCtx = overlayCanvas.getContext('2d');
    const startBtn = document.getElementById('startBtn');

    let marcoPath;
    let rectPath;
    let rectScaleX = 1, rectScaleY = 1;
    let stream;
    let proportionHistory = [];

    const svgPathData = `m225.24178,18c0,0 -1.15224,-0.76537 -3,0c-1.30656,0.5412 -2.82443,0.09789 -4,2c-0.52573,0.85065 -1.07613,0.61732 -2,1c-1.30656,0.5412 -2.07613,1.61732 -3,2c-1.30656,0.5412 -2.29289,0.29289 -3,1c-0.70711,0.70711 -0.29289,1.29289 -1,2c-0.70711,0.70711 -1,1 -2,1c-1,0 -1.07613,0.61732 -2,1c-1.30656,0.5412 -2.61731,1.07612 -3,2c-0.5412,1.30656 -1.29289,1.29289 -2,2c-0.70711,0.70711 -1,1 -2,1c-1,0 -0.69344,1.45881 -2,2c-0.92387,0.38268 -1.29289,0.29289 -2,1c-0.70711,0.70711 -0.29289,1.29289 -1,2c-0.70711,0.70711 -1.29289,0.29289 -2,1c-0.70711,0.70711 -0.29289,1.29289 -1,2c-0.70711,0.70711 -1.29289,0.29289 -2,1c-0.70711,0.70711 -0.69344,2.45881 -2,3c-0.92387,0.38268 -1.07613,0.61732 -2,1c-1.30656,0.54119 -1.07613,1.61732 -2,2c-1.30656,0.54119 -1.69344,1.45881 -3,2c-0.92387,0.38268 -1.29289,1.29289 -2,2c-0.70711,0.70711 -2.29289,0.29289 -3,1c-0.70711,0.70711 -0.29289,1.29289 -1,2c-0.70711,0.70711 -1.29289,0.29289 -2,1c-0.70711,0.70711 -0.29289,1.29289 -1,2c-0.70711,0.70711 -1.29289,0.29289 -2,1c-0.70711,0.70711 -0.29289,1.29289 -1,2c-0.70711,0.70711 -1.29289,0.29289 -2,1c-0.70711,0.70711 -2,0 -3,0c-1,0 -2,0 -3,0c-1,0 -1.29289,-0.29289 -2,-1c-0.70711,-0.70711 -1.29289,-0.29289 -2,-1c-0.70711,-0.70711 -1,-1 -2,-1c-1,0 -2,0 -3,0c-1,0 -2,0 -3,0c-1,0 -2.29289,-0.70711 -3,0c-0.70711,0.70711 -0.61731,1.07612 -1,2c-0.5412,1.30656 -2,2 -2,3c0,1 0,2 0,3c0,1 -0.4588,1.69344 -1,3c-0.38269,0.92388 0,2 0,3c0,1 -1,1 -1,2c0,1 -1,1 -2,1c-1,0 -1.29289,0.29289 -2,1c-0.70711,0.70711 -2.07613,-0.38268 -3,0c-1.30656,0.5412 -2.07613,0.61732 -3,1c-1.30656,0.5412 -1.29289,1.29289 -2,2c-0.70711,0.70711 -2,1 -3,1c-1,0 -2,1 -3,1c-1,0 -1.69344,0.4588 -3,1c-0.92388,0.38268 -2.29289,-0.70711 -3,0c-0.70711,0.70711 -1,1 -2,1c-2,0 -2,1 -4,1c-1,0 -1.87856,0.49346 -5,1c-1.97417,0.32037 -2,1 -3,1c-1,0 -1.29289,0.29289 -2,1c-0.70711,0.70711 -2.29289,-0.70711 -3,0c-0.70711,0.70711 -0.29289,1.29289 -1,2c-0.70711,0.70711 -1.69344,0.4588 -3,1c-0.92388,0.38268 -1.15224,0.23463 -3,1c-1.30656,0.5412 -1.29289,1.29289 -2,2c-0.70711,0.70711 -1.69344,0.4588 -3,1c-0.92388,0.38268 -2,1 -3,1c-1,0 -1.29289,0.29289 -2,1c-0.70711,0.70711 -2,1 -3,1c-1,0 -1,1 -2,1c-1,0 -2.69344,0.4588 -4,1c-0.92388,0.38268 -3,1 -4,1c-1,0 -1.29289,0.29289 -2,1c-0.70711,0.70711 -1.69344,0.4588 -3,1c-0.92388,0.38268 -3.07612,0.61732 -4,1c-1.30656,0.5412 -3.69344,2.4588 -5,3c-0.92388,0.38268 -2.29289,0.29289 -3,1c-0.70711,0.70711 -0.29289,1.29289 -1,2c-0.70711,0.70711 -1,1 -2,1c-1,0 -1,1 -2,1c-1,0 -1.29289,0.29289 -2,1c-0.70711,0.70711 -1.07612,0.61732 -2,1c-1.30656,0.5412 -1.69344,1.4588 -3,2c-0.92388,0.38268 -1.29289,0.29289 -2,1c-0.70711,0.70711 -1.29289,0.29289 -2,1c-0.70711,0.70711 0,2 0,4c0,1 0.30656,2.4588 -1,3c-0.92388,0.38268 -1,1 -2,1c-1,0 -2.4588,-0.30656 -3,1c-0.38268,0.92388 -0.61732,2.07612 -1,3c-0.5412,1.30656 -2.4588,1.69344 -3,3c-0.38268,0.92387 0.38268,2.07613 0,3c-0.5412,1.30656 -1,2 -1,3c0,1 -0.29289,1.29289 -1,2c-1.41421,1.41422 0.70711,3.29289 0,4c-0.70711,0.70711 -0.29289,1.29289 -1,2c-0.70711,0.70711 -0.61732,1.07613 -1,2c-0.5412,1.30656 -1,2 -1,3c0,1 -0.4588,1.69344 -1,3c-0.38268,0.92387 0.38268,2.07613 0,3c-0.5412,1.30656 -0.61732,2.07613 -1,3c-0.5412,1.30656 -0.29289,2.29289 -1,3c-0.70711,0.70711 -1,1 -1,2c0,1 -1,1 -1,2c0,1 0.70711,2.29289 0,3c-0.70711,0.70711 -0.29289,1.29289 -1,2c-0.70711,0.70711 -1.29289,0.29289 -2,1c-0.70711,0.70711 0.70711,2.29289 0,3c-0.70711,0.70711 -1,1 -1,2c0,1 -1,2 -1,3c0,1 0.22975,2.02675 0,3c-0.51374,2.17625 -2,3 -2,5c0,1 -0.29289,1.29289 -1,2c-0.70711,0.70711 0,2 0,3c0,1 0,2 0,3c0,1 0,2 0,3c0,1 1,2 1,3c0,1 0.29289,1.29289 1,2c0.70711,0.70711 -0.70711,2.29289 0,3c0.70711,0.70711 1.29289,0.29289 2,1c0.70711,0.70711 0,2 0,3c0,1 0.70711,2.29289 0,3c-0.70711,0.70711 -1.29289,0.29289 -2,1c-0.70711,0.70711 -0.69344,2.4588 -2,3c-0.92388,0.38269 -1.29289,0.29289 -2,1c-0.70711,0.70711 -1,1 -1,2c0,1 -0.29289,1.29289 -1,2c-0.70711,0.70711 0,2 0,3c0,1 0.70711,2.29289 0,3c-0.70711,0.70711 -1.70711,1.29289 -1,2c0.70711,0.70711 1.4588,0.69344 2,2c0.38268,0.92387 0.29289,1.29289 1,2c0.70711,0.70711 2,0 3,0c1,0 1.29289,1.29289 2,2c0.70711,0.70711 1.61732,0.07613 2,1c0.5412,1.30656 1.29289,2.29289 2,3c0.70711,0.70711 2,0 3,0c1,0 1,1 2,1c1,0 2,0 3,0c1,0 1,1 2,1c1,0 2,0 3,0c1,0 2,0 3,0c1,0 2.29289,-0.70711 3,0c0.70711,0.70711 1.29289,1.29289 2,2c0.70711,0.70711 0.29289,1.29289 1,2c0.70711,0.70711 2.29289,-0.70711 3,0c0.70711,0.70711 0.29289,1.29289 1,2c0.70711,0.70711 2,0 3,0c1,0 1.29289,0.29289 2,1c0.70711,0.70711 1.29289,0.29289 2,1c0.70711,0.70711 1.29289,0.29289 2,1c0.70711,0.70711 1.29289,0.29289 2,1c0.70711,0.70711 1.29289,0.29289 2,1c0.70711,0.70711 0,2 1,2c1,0 0.29289,1.29291 1,2c0.70711,0.70709 1.29289,0.29291 2,1c0.70711,0.70709 1,1 2,1c1,0 1.69344,0.4588 3,1c0.92388,0.38269 1.29289,0.29291 2,1c0.70711,0.70709 2,0 3,0c1,0 2,0 3,0c1,0 1.69344,0.4588 3,1c0.92388,0.38269 1.69344,0.4588 3,1c0.92388,0.38269 2,1 3,1c1,0 1,1 2,1c1,0 2.29289,-0.70709 3,0c0.70711,0.70709 1,1 2,1c1,0 2.29289,-0.70709 3,0c0.70711,0.70709 1,1 2,1c1,0 2,0 3,0c1,0 3,0 4,0c1,0 1.29289,0.29291 2,1c0.70711,0.70709 2,0 3,0c1,0 2,0 3,0c1,0 2,0 3,0c1,0 1.29289,-0.29291 2,-1c1.41422,-1.41422 3.29289,-0.29291 4,-1c0.70711,-0.70709 0.29289,-1.29291 1,-2c0.70711,-0.70709 1.29289,-0.29291 2,-1c0.70711,-0.70709 0.29289,-1.29291 1,-2c0.70711,-0.70709 1.29289,-0.29291 2,-1c0.70711,-0.70709 1,-1 1,-2c0,-1 0.29289,-2.29291 1,-3c0.70711,-0.70711 2,0 3,0c1,0 3,1 5,1c1,0 2,1 4,1c2,0 4.69344,0.4588 6,1c0.92387,0.38269 2,0 3,0c1,0 2,1 3,1c1,0 2,0 3,0c1,0 2,0 4,0c2,0 3,0 4,0c1,0 2,0 3,0c1,0 2,0 3,0c1,0 2,0 3,0c1,0 2,0 3,0c1,0 2,0 3,0c1,0 2,0 3,0c1,0 2,0 3,0c1,0 2,0 3,0c1,0 2,0 3,0c1,0 2,0 3,0c1,0 2,0 3,0c2,0 3,0 4,0c2,0 3,0 4,0c1,0 2,0 3,0c1,0 2.29289,-0.70709 3,0c0.70711,0.70709 1,1 2,1c1,0 2,0 3,0c1,0 2,1 3,1c1,0 2.07613,-0.38269 3,0c1.30656,0.5412 2,1 3,1c1,0 2,0 3,0c1,0 3,0 4,0c1,0 2,0 4,0c1,0 2.58578,-1.41422 4,0c0.70711,0.70709 1,1 2,1c1,0 2.0535,-0.4595 4,0c2.17625,0.51373 6.72958,3.37866 8,4c7.24245,3.54218 10.69345,2.4588 12,3c0.92389,0.38269 2,0 3,0c1,0 1.29291,-1.29291 2,-2c0.70709,-0.70709 1.69345,-0.4588 3,-1c0.92389,-0.38269 1.29291,-0.29291 2,-1c0.70709,-0.70709 2,0 3,0c1,0 2,0 3,0c1,0 2,0 3,0c1,0 2,0 3,0c1,0 2.02676,-0.22977 3,0c2.17624,0.51373 3,1 4,1c1,0 2,0 3,0c1,0 2,0 3,0c1,0 4,0 6,0c1,0 3,1 4,1c1,0 1,1 2,1c1,0 1.29291,0.29291 2,1c0.70709,0.70709 2.07611,-0.38269 3,0c1.30655,0.5412 1.29291,1.29291 2,2c0.70709,0.70709 1.29291,0.29291 2,1c0.70709,0.70709 2.29291,0.29291 3,1c0.70709,0.70709 1.07611,1.61731 2,2c1.30655,0.5412 1.0979,1.82443 3,3c0.85065,0.52573 1,1 2,1c1,0 2,1 3,1c1,0 2.29291,-0.70709 3,0c0.70709,0.70709 1,1 2,1c1,0 1.69345,0.4588 3,1c0.92389,0.38269 2,0 3,0c2,0 3,0 4,0c1,0 2,0 3,0c1,0 2,1 3,1c1,0 2,0 3,0c1,0 2,0 3,0c1,0 2,0 3,0c1,0 1,1 2,1c1,0 2,0 3,0c1,0 2,0 3,0c1,0 2,0 3,0c1,0 2.29291,0.70709 3,0c0.70709,-0.70709 1,-1 2,-1c1,0 1.29291,-0.29291 2,-1c0.70709,-0.70709 1.29291,-0.29291 2,-1c1.41422,-1.41422 3.07611,-0.61731 4,-1c1.30655,-0.5412 1.69345,-1.4588 3,-2c0.92389,-0.38269 1.29291,-1.29291 2,-2c0.70709,-0.70709 2.29291,-0.29291 3,-1c0.70709,-0.70709 0.69345,-1.4588 2,-2c0.92389,-0.38269 1.29291,-0.29291 2,-1c0.70709,-0.70709 0.29291,-1.29291 1,-2c0.70709,-0.70709 1.29291,-0.29291 2,-1c0.70709,-0.70709 0.29291,-1.29291 1,-2c0.70709,-0.70709 0.47427,-1.14935 1,-2c1.17557,-1.9021 2.61731,-2.07611 3,-3c0.5412,-1.30655 2,-1 2,-2c0,-1 1,-1 1,-2c0,-1 -0.70709,-2.29291 0,-3c0.70709,-0.70709 1,-1 1,-2c0,-1 0,-2 0,-3c0,-1 -0.38269,-2.07613 0,-3c0.5412,-1.30656 1.4588,-1.69344 2,-3c0.38269,-0.92387 -0.70709,-2.29289 0,-3c0.70709,-0.70711 0.29291,-1.29289 1,-2c0.70709,-0.70711 2,-1 3,-1c1,0 3,-1 4,-1c1,0 2,0 3,0c1,0 2,0 3,0c1,0 3,-1 4,-1c1,0 2.15225,0.76537 4,0c1.30655,-0.5412 2.02676,-0.77025 3,-1c2.17624,-0.51375 4,-2 5,-2c1,0 1.29291,-0.29289 2,-1c0.70709,-0.70711 1.82376,-0.48625 4,-1c2.91974,-0.68925 5,0 6,0c1,0 1,-1 3,-1c1,0 2.93414,-0.14429 5,-1c2.92157,-1.21014 4,-2 5,-2c1,0 1.29291,-0.29289 2,-1c0.70709,-0.70711 2,0 3,0c1,0 2,-1 3,-1c1,0 3.07843,0.21014 6,-1c2.06586,-0.85571 3,-1 4,-1c1,0 2.29291,0.70711 3,0c0.70709,-0.70711 1,-1 2,-1c1,0 3.07611,0.38269 4,0c1.30655,-0.5412 2,-1 3,-1c1,0 1.69345,-0.4588 3,-1c0.92389,-0.38269 2,-1 3,-1c1,0 1.29291,-0.29289 2,-1c0.70709,-0.70711 2,0 3,-1c1,-1 2,-1 3,-1c1,0 2,0 3,0c1,0 2.87866,-2.12132 5,0c0.70709,0.70711 1.07611,0.61731 2,1c1.30658,0.5412 1.4588,2.69344 2,4c0.38269,0.92387 0.29291,1.29289 1,2c0.70709,0.70711 2.07611,1.61731 3,2c1.30658,0.5412 1,2 2,2c1,0 2.07611,-0.38269 3,0c1.30658,0.5412 1.29291,1.29289 2,2c0.70709,0.70711 1.69342,0.4588 3,1c0.92389,0.38269 2,1 3,1c1,0 2.29291,-0.70711 3,0c0.70709,0.70711 1.82373,1.48625 4,2c0.97327,0.22975 2,0 4,0c1,0 2,0 3,0c1,0 2,0 3,0c1,0 2,0 3,0c1,0 2,0 3,0c1,0 2.29291,0.70711 3,0c0.70709,-0.70711 1,-1 2,-2c1,-1 1.29291,-1.29289 2,-2c0.70709,-0.70711 1.4588,-0.69344 2,-2c0.38269,-0.92387 0.61731,-1.07613 1,-2c0.5412,-1.30656 1.29291,-2.29289 2,-3c0.70709,-0.70711 1.29291,-1.29289 2,-2c0.70709,-0.70711 1.4588,-0.69344 2,-2c0.38269,-0.92387 0.29291,-1.29289 1,-2c0.70709,-0.70711 1,-2 1,-3c0,-1 1,-1 1,-2c0,-1 0,-2 0,-3c0,-1 0,-2 0,-3c0,-1 0.4588,-1.69344 1,-3c0.38269,-0.92387 -0.38269,-2.07613 0,-3c0.5412,-1.30656 1.4588,-1.69344 2,-3c0.38269,-0.92387 1,-2 1,-3c0,-1 1,-2 1,-3c0,-1 0.29291,-2.29289 1,-3c0.70709,-0.70711 1,-1 1,-2c0,-1 1,-1 1,-2c0,-1 0.29291,-1.29289 1,-2c0.70709,-0.70711 0.29291,-1.29289 1,-2c0.70709,-0.70711 0.61731,-1.07613 1,-2c0.5412,-1.30656 1.29291,-1.29289 2,-2c0.70709,-0.70711 0,-2 0,-3c0,-1 0,-2 0,-3c0,-1 0,-2 0,-3c0,-1 0,-2 0,-3c0,-1 0,-2 0,-3c0,-1 0,-2 0,-3c0,-1 0,-2 0,-3c0,-1 0,-2 0,-3c0,-1 0,-2 0,-3c0,-1 0,-2 0,-3c0,-1 1,-1 1,-2c0,-1 1,-2 1,-3c0,-1 0,-2 0,-3c0,-1 0,-2 0,-3c0,-2 0,-3 0,-4c0,-1 0,-2 0,-3c0,-1 0,-2 0,-3c0,-1 -1,-1 -1,-2c0,-1 -0.4588,-1.69344 -1,-3c-0.38269,-0.92388 0,-2 0,-3c0,-1 -1,-1 -1,-2c0,-1 0,-2 0,-3c0,-1 -0.29291,-1.29289 -1,-2c-0.70709,-0.70711 0,-2 0,-3c0,-1 -0.29291,-1.29289 -1,-2c-0.70709,-0.70711 0,-2 0,-3c0,-1 0,-2 0,-3c0,-1 0,-2 0,-3c0,-1 0,-2 0,-3c0,-1 0,-2 0,-3c0,-1 0,-2 0,-3c0,-1 -0.29291,-1.29289 -1,-2c-0.70709,-0.70711 0.70709,-2.29289 0,-3c-0.70709,-0.70711 -1,-1 -2,-1c-1,0 -2,0 -3,0c-1,0 -2,0 -3,0c-1,0 -1.29291,-1.29289 -2,-2c-0.70709,-0.70711 -1.4588,-0.69344 -2,-2c-0.38269,-0.92388 -0.29291,-1.29289 -1,-2c-0.70709,-0.70711 -0.4588,-1.69344 -1,-3c-0.38269,-0.92388 -1,-1 -1,-2c0,-1 -0.29291,-1.29289 -1,-2c-0.70709,-0.70711 0.70709,-2.29289 0,-3c-0.70709,-0.70711 -1.95514,-0.54916 -3,-4c-0.28979,-0.95709 -0.61731,-2.07612 -1,-3c-0.5412,-1.30656 -2.29291,-1.29289 -3,-2c-0.70709,-0.70711 -0.61731,-2.07612 -1,-3c-0.5412,-1.30656 -2,-2 -3,-3c-1,-1 -2,-2 -3,-3c-1,-1 -2.29291,-1.29289 -3,-2c-0.70709,-0.70711 -1.4588,-0.69344 -2,-2c-0.38269,-0.92388 -1.29291,-0.29289 -2,-1c-0.70709,-0.70711 -1.29291,-1.29289 -2,-2c-0.70709,-0.70711 -0.29291,-1.29289 -1,-2c-0.70709,-0.70711 -1.69342,-1.45881 -3,-2c-0.92389,-0.38268 -2.29291,-0.29289 -3,-1c-0.70709,-0.70711 -1.29291,-1.29289 -2,-2c-0.70709,-0.70711 -0.29291,-1.29289 -1,-2c-0.70709,-0.70711 -1.29291,-0.29289 -2,-1c-0.70709,-0.70711 -1.29291,-0.29289 -2,-1c-0.70709,-0.70711 -0.69342,-1.4588 -2,-2c-0.92389,-0.38268 -1.69342,-1.4588 -3,-2c-0.92389,-0.38268 -1,-1 -2,-1c-1,0 -1.29291,-0.29289 -2,-1c-0.70709,-0.70711 -0.69342,-1.4588 -2,-2c-0.92389,-0.38268 -1.07611,-0.61732 -2,-1c-1.30658,-0.5412 -2.29291,-0.29289 -3,-1c-0.70709,-0.70711 -1.29291,-1.29289 -2,-2c-0.70709,-0.70711 -1.07611,-0.61732 -2,-1c-1.30658,-0.5412 -1.61731,-1.07612 -2,-2c-0.5412,-1.30656 -2.29291,-0.29289 -3,-1c-0.70709,-0.70711 -0.29291,-1.29289 -1,-2c-0.70709,-0.70711 -2,0 -3,-1c-1,-1 -1.69345,-1.4588 -3,-2c-0.92389,-0.38268 -2.69345,-1.4588 -4,-2c-0.92389,-0.38268 -1.82376,-0.48626 -4,-1c-0.97324,-0.22975 -1.29291,-0.29289 -2,-1c-0.70709,-0.70711 -2,-1 -3,-1c-1,0 -2.29291,0.70711 -3,0c-0.70709,-0.70711 -1,-1 -2,-1c-1,0 -2.07611,0.38268 -3,0c-1.30655,-0.5412 -2,-1 -3,-1c-1,0 -2.07611,0.38268 -3,0c-1.30655,-0.5412 -1.69345,-1.4588 -3,-2c-0.92389,-0.38268 -2,0 -3,0c-2,0 -4.69345,-0.4588 -6,-1c-2.77164,-1.14805 -4,0 -5,0c-1,0 -2,0 -5,0c-4,0 -6,0 -7,0c-2,0 -4,0 -5,0c-1,0 -5,0 -7,0c-2,0 -3,0 -4,0c-1,0 -2,0 -3,0c-1,0 -2,0 -3,0c-1,0 -3,1 -5,1c-2,0 -3,0 -4,0c-1,0 -2,0 -3,0c-2,0 -4,0 -5,0c-2,0 -4,0 -6,0c-1,0 -2,0 -6,0c-2,0 -6.02582,-0.32036 -8,0c-3.12143,0.50654 -6,1 -9,1c-1,0 -2,0 -4,0c-1,0 -3,0 -5,0c-1,0 -2,0 -3,0c-1,0 -2,0 -3,0c-1,0 -2,0 -7,0c-1,0 -3,0 -5,0c-1,0 -2,0 -3,0c-1,0 -2,0 -3,0c-1,0 -2,0 -3,0c-1,0 -2,0 -4,0c-6,0 -9,0 -15,0c-2,0 -5,0 -7,0c-1,0 -2,0 -3,0c-2,0 -4,0 -7,0c-1,0 -3,0 -4,0c-1,0 -1,1 -2,1c-1,0 -2,0 -3,0c-1,0 -2,0 -4,0c-2,0 -6,0 -8,0c-2,0 -3,0 -5,0c-1,0 -3,0 -5,0c-2,0 -6,0 -7,0c-4,0 -5,1 -6,1c-1,0 -2.02676,-0.22975 -3,0c-2.17624,0.51374 -3,1 -4,1c-2,0 -3,0 -4,0c-1,0 -1.29289,0.29289 -2,1c-0.70711,0.70711 -2,0 -3,0c-1,0 -2,1 -3,1c-1,0 -2.61731,0.07612 -3,1c-0.5412,1.30656 -2.58578,-0.41421 -4,1c-0.70711,0.70711 -0.69344,1.4588 -2,2c-0.92387,0.38268 -1.29289,0.29289 -2,1c-0.70711,0.70711 -0.29289,1.29289 -1,2c-0.70711,0.70711 -1,1 -2,1c-1,0 -0.69344,1.4588 -2,2c-0.92387,0.38268 -1,1 -2,1c-1,0 -3,1 -4,2l-2,0l0,1`;
    const svgWidth = 597;  // ancho original del SVG
    const svgHeight = 289;  // alto original del SVG

    const rectPathData = `M 0.73,0.73
  C 0.73,0.73 595.16,1.10 595.16,1.10
    595.16,1.10 594.79,286.96 594.79,286.96
    594.79,286.96 2.20,286.60 2.20,286.60
    2.20,286.60 0.73,0.73 0.73,0.73 Z`;
    const rectWidth = 597;   // ancho del SVG rect
    const rectHeight = 289;  // alto del SVG rect

    function createScaledPath(d, canvasWidth, canvasHeight) {
      const rawPath = new Path2D(d);

      const marginX = canvasWidth * 0.05;
      const marginY = canvasHeight * 0.05;

      const availableWidth = canvasWidth - 2 * marginX;
      const availableHeight = canvasHeight - 2 * marginY;

      const scaleX = availableWidth / svgWidth;
      const scaleY = availableHeight / svgHeight;

      const offsetX = marginX;
      const offsetY = marginY;

      const transformed = new Path2D();
      transformed.addPath(rawPath, new DOMMatrix()
        .translate(offsetX, offsetY)
        .scale(scaleX, scaleY)
      );

      return { path: transformed, scaleX, scaleY };
    }

    window.onload = async () => {
      try {
        feedback.innerText = "Requesting camera access...";
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }});
        feedback.innerText = "Camera ready. Press start.";
      } catch (err) {
        feedback.innerText = "❌ Couldn't access the camera.";
        console.error(err);
      }
    };

    async function requestFullscreenAndOrientation() {
      try {
        if (document.documentElement.requestFullscreen) {
          await document.documentElement.requestFullscreen();
        } else if (document.documentElement.webkitRequestFullscreen) {
          await document.documentElement.webkitRequestFullscreen();
        }
        if (screen.orientation && screen.orientation.lock) {
          await screen.orientation.lock("landscape");
        }
      } catch (err) {
        console.warn("⚠️ Can't activate fullscreen:", err);
      }
    }

    async function initCamera() {
      
      video.srcObject = stream;

      return new Promise((resolve) => {
        video.onloadedmetadata = () => {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          overlayCanvas.width = video.videoWidth;
          overlayCanvas.height = video.videoHeight;

          initCanvas();
          resolve();
        };
      });
    }

    async function initCanvas() {
      overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);

      // --- Marco irregular ---
      const marcoScaledPath = createScaledPath(svgPathData, overlayCanvas.width, overlayCanvas.height);
      marcoPath = marcoScaledPath.path;
      overlayCtx.strokeStyle = "lime";
      overlayCtx.lineWidth = 4;
      overlayCtx.setLineDash([10, 6]);
      overlayCtx.stroke(marcoPath);

      // --- Rectángulo de referencia ---
      const rectScaledPath = createScaledPath(rectPathData, overlayCanvas.width, overlayCanvas.height);
      rectPath = rectScaledPath.path;
      rectScaleX = rectScaledPath.scaleX;
      rectScaleY = rectScaledPath.scaleY;

      overlayCtx.strokeStyle = "yellow";
      overlayCtx.lineWidth = 3;
      overlayCtx.setLineDash([]);
      overlayCtx.stroke(rectPath);
    }

    function rectDentroDePath(x, y, w, h, path, ctx) {
      const puntos = [[x, y], [x+w, y], [x, y+h], [x+w, y+h]];
      return puntos.every(([px, py]) => ctx.isPointInPath(path, px, py));
    }

    function updateChart(value) {
      proportionHistory.push(value);
      if (proportionHistory.length > 50) proportionHistory.shift();

      chartCtx.clearRect(0, 0, proportionChart.width, proportionChart.height);

      const rangeMin = 0.3;
      const rangeMax = 0.6;

      const mapValueToY = (v) => proportionChart.height * (1 - (v -rangeMin) / (rangeMax - rangeMin));

      // Dibujar líneas de referencia (0.35 y 0.5)
      const thresholds = [
        { value: 0.35, color: "orange" },
        { value: 0.5, color: "red" }
      ];

      thresholds.forEach(t => {
        const y = mapValueToY(t.value);
        chartCtx.beginPath();
        chartCtx.strokeStyle = t.color;
        chartCtx.setLineDash([4, 4]);
        chartCtx.moveTo(0, y);
        chartCtx.lineTo(proportionChart.width, y);
        chartCtx.stroke();
      });
      chartCtx.setLineDash([]); // reset

      // Dibujar curva de proporción
      chartCtx.beginPath();
      chartCtx.strokeStyle = "#0ff";
      chartCtx.lineWidth = 2;

      proportionHistory.forEach((val, i) => {
        const x = (i / 49) * proportionChart.width;
        const y = mapValueToY(val); // escala vertical
        if (i === 0) chartCtx.moveTo(x, y);
        else chartCtx.lineTo(x, y);
      });

      chartCtx.stroke();
    }

    async function runDetection() {
      feedback.innerText = "Loading ODM...";
      const model = await cocoSsd.load({base: 'mobilenet_v2'});
      feedback.innerText = "ODM completely loaded. Searching car...";

      setInterval(async () => {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const predictions = await model.detect(canvas);

        detectionsBox.innerText = predictions.length > 0
          ? predictions.map(p => `${p.class} (${(p.score*100).toFixed(1)}%)`).join("\n")
          : "No detections";

        overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
        initCanvas(); // redibuja marcos

        predictions.forEach(p => {
          const [x, y, w, h] = p.bbox;
          overlayCtx.strokeStyle = "red";
          overlayCtx.lineWidth = 2;
          overlayCtx.strokeRect(x, y, w, h);

          overlayCtx.fillStyle = "red";
          overlayCtx.font = "16px monospace";
          overlayCtx.fillText(`${p.class} ${(p.score*100).toFixed(1)}%`, x, y > 20 ? y - 5 : y + 15);
        });

        const car = predictions.find(p => ["car", "truck", "bus"].includes(p.class));

        if (car) {
          const [x, y, w, h] = car.bbox;
          const dentro = rectDentroDePath(x, y, w, h, rectPath, overlayCtx);

          const carArea = w * h;
          //const marcoBox = overlayCanvas.width * 0.6 * overlayCanvas.height * 0.3;
          const rectArea = (rectWidth * rectScaleX) * (rectHeight * rectScaleY);
          //const proportion = carArea / marcoBox;
          const proportion = carArea / rectArea;

          proportionBox.firstChild.textContent = `Proportion: ${proportion.toFixed(2)}`;
          updateChart(proportion);

          if (!dentro || proportion > 0.5) {
            feedback.innerText = "Adjust the framing or step back a little. 🚗⬅️";
          } else if (proportion < 0.35) {
            feedback.innerText = "You're too far 🚗➡️";
          } else {
            feedback.innerText = "Perfect! 📸";
          }
        } else {
          feedback.innerText = "I cannot detect the car, adjust the framing.";
          proportionBox.firstChild.textContent = "Proportion: N/A";
        }
      }, 1000);
    }

    startBtn.addEventListener("click", async () => {
      startBtn.style.display = "none";
      await requestFullscreenAndOrientation();
      await initCamera().then(runDetection());
    });
  </script>
</body>
</html>
